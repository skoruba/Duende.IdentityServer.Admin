// Copyright (c) Jan Škoruba. All Rights Reserved.
// Licensed under the Apache License, Version 2.0.

using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.AspNetCore.TestHost;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Configuration;
using Microsoft.AspNetCore.Authentication.Cookies;
using Skoruba.Duende.IdentityServer.Admin.Configuration.Test;

namespace Skoruba.Duende.IdentityServer.Admin.IntegrationTests.Common
{
    public class CustomWebApplicationFactory : WebApplicationFactory<StartupTest>
    {
        builder
             .UseEnvironment("Testing")
             .ConfigureAppConfiguration((hostContext, configApp) =>
             {
                 configApp.AddJsonFile("appsettings.json", optional: true, reloadOnChange: true);
                 configApp.AddJsonFile("serilog.json", optional: true, reloadOnChange: true);
        
                 var env = hostContext.HostingEnvironment;
        
                 configApp.AddJsonFile($"serilog.{env.EnvironmentName}.json", optional: true, reloadOnChange: true);
                 configApp.AddJsonFile($"appsettings.{env.EnvironmentName}.json", optional: true, reloadOnChange: true);
             })
             .ConfigureTestServices(services =>
             {
                 services.PostConfigure<AuthenticationOptions>(options =>
                 {
                     options.DefaultAuthenticateScheme = CookieAuthenticationDefaults.AuthenticationScheme;
                     options.DefaultChallengeScheme = CookieAuthenticationDefaults.AuthenticationScheme;
                 });
             });
    }
}
