import{j as e}from"./ui-vendor-BHgw9ghC.js";import{R as H,a as j}from"./react-vendor-BOADiDeY.js";import{c as J,aP as U,ad as X,B as E,a7 as S,a2 as Y,aQ as T,an as A,V as F,N as L,P as I,aR as P,aS as W,aT as Z,a6 as _,h as z,D as M,x as ee,y as ie,z as se,L as Q,j as V,S as ne}from"./index-DAD0hXUP.js";import{S as te,f as ae,g as oe,h as re,i as le,P as ce}from"./table-BczK1sh7.js";import{u as ue}from"./modalHooks-ejr9IXPU.js";import{D as de}from"./DataTable-V4omrcUa.js";import{c as ge,t as me,F as pe,L as fe,a as R}from"./FormRow-BNhhe82P.js";import{u as q}from"./useMutation-B7qVQHXu.js";import{I as ye}from"./IssueTypeBadge-tnVFP3f9.js";import{u as N}from"./i18n-vendor-CiQkzSQO.js";import{T as xe}from"./trash-2-l37Lmxoo.js";import{s as b,n as he,c as O,o as B,d as K,e as Re,u as Ce}from"./form-vendor-BmuYqd71.js";import{C as Te}from"./circle-plus-BsVCEPVX.js";import"./utils-zj3SKzMM.js";import"./Card-C9DSQP6u.js";import"./table-vendor-48jR4ZlK.js";import"./input-ycrf_3uL.js";import"./calendar-2y-kU49Q.js";import"./DateTimeHelper-QWEMCMQL.js";import"./circle-x-DjrKbhmp.js";import"./info-DXIB1L4c.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=J("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),v=new U(X.getApiBaseUrl()),je=async()=>await v.get(),ve=async i=>{await v.post(i)},Se=async(i,y)=>{await v.put(i,y)},Ee=async i=>{await v.delete(i)},Ne=async i=>{await v.toggleRule(i)},De=async()=>await v.getAllMetadata(),we=({data:i,onEdit:y,onRefresh:g})=>{const{t:u}=N(),d=q(t=>Ne(t),{onSuccess:()=>{g()},onError:()=>{F({variant:"destructive",title:u("ConfigurationRules.ToggleFailed"),description:u("ConfigurationRules.GenericError")})}}),o=q(t=>Ee(t),{onSuccess:()=>{g()},onError:()=>{F({variant:"destructive",title:u("ConfigurationRules.DeleteFailed"),description:u("ConfigurationRules.GenericError")})}}),l=async t=>{await d.mutateAsync(t.id)},x=async t=>{confirm(u("ConfigurationRules.ConfirmDelete"))&&await o.mutateAsync(t)},h=t=>{const f=String(t)==="Error"||t===T.Error,D=String(t)==="Warning"||t===T.Warning;let p;return f?p=u("ConfigurationRules.Error"):D?p=u("ConfigurationRules.Warning"):p=u("ConfigurationRules.Recommendation"),e.jsx(ye,{type:t===T.Error?A.Error:t===T.Warning?A.Warning:A.Recommendation,label:p})},C=t=>{const f={[S.Client]:"outline",[S.ApiScope]:"outline",[S.ApiResource]:"outline",[S.IdentityResource]:"outline"};return e.jsx(Y,{variant:f[t]||"default",children:t})},n=[{accessorKey:"ruleType",header:u("ConfigurationRules.RuleType"),cell:({row:t})=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.original.ruleType}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.original.messageTemplate})]})},{accessorKey:"resourceType",header:u("ConfigurationRules.ResourceType"),cell:({row:t})=>C(t.original.resourceType)},{accessorKey:"issueType",header:u("ConfigurationRules.IssueType"),cell:({row:t})=>h(t.original.issueType)},{accessorKey:"isEnabled",header:u("ConfigurationRules.Enabled"),cell:({row:t})=>e.jsx(ge,{checked:t.original.isEnabled,onCheckedChange:()=>l(t.original),disabled:d.isLoading})},{id:"actions",header:u("Actions.Actions"),cell:({row:t})=>e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>y(t.original),children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>x(t.original.id),disabled:o.isLoading,children:e.jsx(xe,{className:"h-4 w-4 text-destructive"})})]})}];return e.jsx(de,{columns:n,data:i.rules||[],pagination:{pageIndex:0,pageSize:10,hidePagination:!0},setPagination:()=>{},totalCount:i.totalCount})},Ae=({rule:i,existingRules:y,metadata:g,onSubmit:u,isEditMode:d})=>{const{t:o}=N(),[l,x]=H.useState(""),h=j.useCallback(s=>o("Validation.FieldRequired",{field:s}),[o]),C=l||(i==null?void 0:i.ruleType),n=g==null?void 0:g.find(s=>String(s.ruleType)===String(C)),t=!d&&l&&y.some(s=>s.ruleType===l),f=j.useCallback(()=>{const s={isEnabled:O(),issueType:he(T),messageTemplate:b().min(1,h(o("ConfigurationRules.MessageTemplate"))),fixDescription:b().optional()};if(!(n!=null&&n.parameters))return B(s);const a={};return n.parameters.forEach(r=>{const m=r.name||"";switch(r.type){case"string":{const c=r.displayName||m||"Configuration parameter";a[m]=r.required?b().min(1,{message:h(c)}):b().optional()}break;case"number":{let c=Re();r.minValue!==void 0&&(c=c.min(r.minValue)),r.maxValue!==void 0&&(c=c.max(r.maxValue)),a[m]=r.required?c:c.optional()}break;case"boolean":a[m]=O();break;case"array":{const c=r.displayName||m||"Configuration parameter";a[m]=r.required?K(b()).min(1,{message:o("Validation.AtLeastOneItemField",{field:c})}):K(b()).optional()}break}}),B({...s,...a})},[n,h,o]),D=j.useMemo(()=>f(),[f]),p=Ce({resolver:me(D),mode:"onSubmit"});j.useEffect(()=>{var s;if(i&&d){x(i.ruleType);let a={};try{a=i.configuration?JSON.parse(i.configuration):{}}catch{a={}}(s=n==null?void 0:n.parameters)==null||s.forEach(r=>{r.type==="array"&&a[r.name||""]===void 0&&(a[r.name||""]=[])}),p.reset({isEnabled:i.isEnabled,issueType:i.issueType,messageTemplate:i.messageTemplate||"",fixDescription:i.fixDescription||"",...a})}else!i&&!l&&p.reset({isEnabled:!0,issueType:T.Recommendation,messageTemplate:"",fixDescription:""})},[i,d,n==null?void 0:n.parameters,p,l]),j.useEffect(()=>{var s;if(l&&!d&&n){let a={};try{a=n.defaultConfiguration?JSON.parse(n.defaultConfiguration):{}}catch{a={}}(s=n.parameters)==null||s.forEach(r=>{r.type==="array"&&a[r.name||""]===void 0&&(a[r.name||""]=r.defaultValue||[])}),p.reset({isEnabled:!0,issueType:T.Recommendation,messageTemplate:n.defaultMessageTemplate||"",fixDescription:n.defaultFixDescription||"",...a})}},[l,d,n,p]);const $=s=>{var k;if(!d&&!l)return;const a=d?i==null?void 0:i.ruleType:l||void 0;if(!a)return;const r=P(S,n==null?void 0:n.resourceType)?n==null?void 0:n.resourceType:i==null?void 0:i.resourceType;if(!r)return;const m={};(k=n==null?void 0:n.parameters)==null||k.forEach(G=>{const w=G.name||"";s[w]!==void 0&&(m[w]=s[w])});const c=i?new W(i):new W;c.id=(i==null?void 0:i.id)??0,c.createdAt=(i==null?void 0:i.createdAt)??new Date,c.updatedAt=i==null?void 0:i.updatedAt,c.ruleType=a,c.resourceType=r,c.isEnabled=s.isEnabled,c.issueType=s.issueType,c.messageTemplate=s.messageTemplate,c.fixDescription=s.fixDescription||void 0,c.configuration=Object.keys(m).length>0?JSON.stringify(m):void 0,u(c)};return e.jsx(pe,{...p,children:e.jsxs("form",{onSubmit:p.handleSubmit($),className:"space-y-4",children:[n&&e.jsx(L,{children:e.jsx(I,{children:n.description})}),!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(fe,{children:[o("ConfigurationRules.RuleType")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs(te,{value:l||void 0,onValueChange:s=>{P(Z,s)?x(s):x("")},children:[e.jsx(ae,{children:e.jsx(oe,{placeholder:o("ConfigurationRules.SelectRuleType")})}),e.jsx(re,{children:g==null?void 0:g.map(s=>{const a=String(s.ruleType);return e.jsxs(le,{value:a,children:[s.displayName," (",s.resourceType,")"]},a)})})]}),t&&e.jsx(L,{variant:"destructive",children:e.jsx(I,{children:o("ConfigurationRules.DuplicateRuleError")})})]}),(d||l)&&e.jsxs(e.Fragment,{children:[e.jsx(R,{name:"isEnabled",label:o("ConfigurationRules.Enabled"),type:"switch"}),e.jsx(R,{name:"issueType",label:o("ConfigurationRules.IssueType"),required:!0,type:"select",selectSettings:{options:[{value:"Warning",label:o("ConfigurationRules.Warning")},{value:"Recommendation",label:o("ConfigurationRules.Recommendation")},{value:"Error",label:o("ConfigurationRules.Error")}]}}),e.jsx(R,{name:"messageTemplate",label:o("ConfigurationRules.MessageTemplate"),description:o("ConfigurationRules.MessageTemplateDescription"),required:!0,type:"input",maxLength:500}),e.jsx(R,{name:"fixDescription",label:o("ConfigurationRules.FixDescription"),description:o("ConfigurationRules.FixDescriptionDescription"),type:"textarea",maxLength:1e3})]}),(n==null?void 0:n.parameters)&&n.parameters.length>0&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsx("h3",{className:"font-semibold",children:o("ConfigurationRules.ConfigurationParameters")}),n.parameters.map(s=>{var r,m;const a=s.name||"";switch(s.type){case"string":return e.jsx(R,{name:a,label:s.displayName||a,description:s.description,required:s.required,type:"input",placeholder:(r=s.defaultValue)==null?void 0:r.toString()},a);case"number":return e.jsx(R,{name:a,label:s.displayName||a,description:`${s.description||""} ${s.minValue!==void 0&&s.maxValue!==void 0?`(${s.minValue} - ${s.maxValue})`:""}`,required:s.required,type:"number",placeholder:(m=s.defaultValue)==null?void 0:m.toString(),numberSettings:{showFormattedTime:!1}},a);case"boolean":return e.jsx(R,{name:a,label:s.displayName||a,description:s.description,type:"switch"},a);case"array":return e.jsx(R,{name:a,label:s.displayName||a,description:s.description,required:s.required,type:"inputWithTable"},a);default:return null}})]}),e.jsx("div",{className:"flex justify-end gap-2 pt-4",children:e.jsx(E,{type:"submit",disabled:t||!d&&!l,children:o("Actions.Save")})})]})})},Fe=({rule:i,existingRules:y,isOpen:g,onClose:u,onSuccess:d})=>{const{t:o}=N(),l=!!i,x=_(),{data:h,isLoading:C}=z(["configurationRulesMetadata"],De,{enabled:g}),n=q(async f=>{l&&i?await Se(i.id,f):await ve(f)},{onSuccess:()=>{x.invalidateQueries([V.configurationIssues]),x.invalidateQueries([V.configurationIssuesSummary]),d()},onError:()=>{F({variant:"destructive",title:o("ConfigurationRules.SaveFailed"),description:o("ConfigurationRules.GenericError")})}}),t=f=>{n.mutate(f)};return e.jsx(M,{open:g,onOpenChange:u,children:e.jsxs(ee,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ie,{children:e.jsx(se,{children:o(l?"ConfigurationRules.EditRule":"ConfigurationRules.AddNewRule")})}),C?e.jsx(Q,{}):h&&e.jsx(Ae,{rule:i,existingRules:y,metadata:h,onSubmit:t,isEditMode:l})]})})},Me=()=>{var n;const{isOpen:i,closeModal:y,openModal:g}=ue(),{t:u}=N(),[d,o]=j.useState(null),l=z([V.configurationRules],()=>je(),{keepPreviousData:!0}),x=()=>{o(null),g()},h=t=>{o(t),g()},C=e.jsx("div",{className:"flex flex-col space-y-3 md:flex-row md:items-center md:space-x-3 md:space-y-0",children:e.jsxs(E,{onClick:x,children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),u("ConfigurationRules.AddNewRule")]})});return e.jsx(ce,{title:u("ConfigurationRules.PageTitle"),icon:ne,accentKind:"management",topSection:C,children:l.isLoading?e.jsx(Q,{fullscreen:!0}):l.data?e.jsxs(e.Fragment,{children:[e.jsx(we,{data:l.data,onEdit:h,onRefresh:l.refetch}),e.jsx(Fe,{rule:d,existingRules:((n=l.data)==null?void 0:n.rules)||[],isOpen:i,onClose:y,onSuccess:()=>{y(),l.refetch()}})]}):null})};export{Me as default};
