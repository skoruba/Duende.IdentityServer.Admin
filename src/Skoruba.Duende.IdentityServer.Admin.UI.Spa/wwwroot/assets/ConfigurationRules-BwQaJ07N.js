import{j as e}from"./ui-vendor-B17-n605.js";import{R as H,a as E}from"./react-vendor-DPOhIiRq.js";import{c as J,aP as U,ad as M,B as N,a7 as S,a2 as X,aQ as T,an as F,V,N as I,P as k,aR as P,aS as W,aT as Y,a6 as Z,u as z,D as _,x as ee,y as ie,z as se,L as Q,j as q,S as ne}from"./index-DVaCOlPw.js";import{S as te,f as ae,g as oe,h as re,i as le,P as ce}from"./table-BGjshbTt.js";import{u as ue}from"./modalHooks-CXBaxWb4.js";import{D as de}from"./DataTable-CuhqpYks.js";import{c as ge,t as me,F as pe,L as fe,a as R}from"./FormRow-CDTEjXNe.js";import{u as L}from"./useMutation-B5d3wT4v.js";import{I as ye}from"./IssueTypeBadge-BU0YKpSB.js";import{u as D}from"./i18n-vendor-TY_g4tCM.js";import{T as xe}from"./trash-2-Fp7mdsHF.js";import{u as he,s as j,n as Re,c as O,o as B,d as K,e as Ce}from"./form-vendor-DdiMXTjA.js";import{C as Te}from"./circle-plus-DA3BdJZL.js";import"./utils-BBmT1Bs5.js";import"./Card-DWFSUPWV.js";import"./table-vendor-Cc_vDqy9.js";import"./input-BXtLITbC.js";import"./calendar-D3BrAClO.js";import"./DateTimeHelper-8fem5lKY.js";import"./circle-x-DVcAMnRl.js";import"./info-xxxE2Amv.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=J("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),v=new U(M.getApiBaseUrl()),je=async()=>await v.get(),ve=async i=>{await v.post(i)},Se=async(i,p)=>{await v.put(i,p)},Ee=async i=>{await v.delete(i)},Ne=async i=>{await v.toggleRule(i)},De=async()=>await v.getAllMetadata(),we=({data:i,onEdit:p,onRefresh:g})=>{const{t:c}=D(),d=L(t=>Ne(t),{onSuccess:()=>{g()},onError:()=>{V({variant:"destructive",title:c("ConfigurationRules.ToggleFailed"),description:c("ConfigurationRules.GenericError")})}}),o=L(t=>Ee(t),{onSuccess:()=>{g()},onError:()=>{V({variant:"destructive",title:c("ConfigurationRules.DeleteFailed"),description:c("ConfigurationRules.GenericError")})}}),l=async t=>{await d.mutateAsync(t.id)},f=async t=>{confirm(c("ConfigurationRules.ConfirmDelete"))&&await o.mutateAsync(t)},h=t=>{const y=String(t)==="Error"||t===T.Error,w=String(t)==="Warning"||t===T.Warning;let x;return y?x=c("ConfigurationRules.Error"):w?x=c("ConfigurationRules.Warning"):x=c("ConfigurationRules.Recommendation"),e.jsx(ye,{type:t===T.Error?F.Error:t===T.Warning?F.Warning:F.Recommendation,label:x})},C=t=>{const y={[S.Client]:"outline",[S.ApiScope]:"outline",[S.ApiResource]:"outline",[S.IdentityResource]:"outline"};return e.jsx(X,{variant:y[t]||"default",children:t})},n=[{accessorKey:"ruleType",header:c("ConfigurationRules.RuleType"),cell:({row:t})=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.original.ruleType}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.original.messageTemplate})]})},{accessorKey:"resourceType",header:c("ConfigurationRules.ResourceType"),cell:({row:t})=>C(t.original.resourceType)},{accessorKey:"issueType",header:c("ConfigurationRules.IssueType"),cell:({row:t})=>h(t.original.issueType)},{accessorKey:"isEnabled",header:c("ConfigurationRules.Enabled"),cell:({row:t})=>e.jsx(ge,{checked:t.original.isEnabled,onCheckedChange:()=>l(t.original),disabled:d.isLoading})},{id:"actions",header:c("Actions.Actions"),cell:({row:t})=>e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>p(t.original),children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>f(t.original.id),disabled:o.isLoading,children:e.jsx(xe,{className:"h-4 w-4 text-destructive"})})]})}];return e.jsx(de,{columns:n,data:i.rules||[],pagination:{pageIndex:0,pageSize:10,hidePagination:!0},setPagination:()=>{},totalCount:i.totalCount})},Ae=({rule:i,existingRules:p,metadata:g,onSubmit:c,isEditMode:d})=>{const{t:o}=D(),[l,f]=H.useState(""),h=s=>o("Validation.FieldRequired",{field:s}),C=l||(i==null?void 0:i.ruleType),n=g==null?void 0:g.find(s=>String(s.ruleType)===String(C)),t=!d&&l&&p.some(s=>s.ruleType===l),y=()=>{const s={isEnabled:O(),issueType:Re(T),messageTemplate:j().min(1,h(o("ConfigurationRules.MessageTemplate"))),fixDescription:j().optional()};if(!(n!=null&&n.parameters))return B(s);const a={};return n.parameters.forEach(r=>{const m=r.name||"";switch(r.type){case"string":{const b=r.displayName||m||"Configuration parameter";a[m]=r.required?j().min(1,{message:h(b)}):j().optional()}break;case"number":let u=Ce();r.minValue!==void 0&&(u=u.min(r.minValue)),r.maxValue!==void 0&&(u=u.max(r.maxValue)),a[m]=r.required?u:u.optional();break;case"boolean":a[m]=O();break;case"array":{const b=r.displayName||m||"Configuration parameter";a[m]=r.required?K(j()).min(1,{message:o("Validation.AtLeastOneItemField",{field:b})}):K(j()).optional()}break}}),B({...s,...a})},w=E.useMemo(()=>y(),[n]),x=he({resolver:me(w),mode:"onSubmit"});E.useEffect(()=>{var s;if(i&&d){f(i.ruleType);let a={};try{a=i.configuration?JSON.parse(i.configuration):{}}catch{a={}}(s=n==null?void 0:n.parameters)==null||s.forEach(r=>{r.type==="array"&&a[r.name||""]===void 0&&(a[r.name||""]=[])}),x.reset({isEnabled:i.isEnabled,issueType:i.issueType,messageTemplate:i.messageTemplate||"",fixDescription:i.fixDescription||"",...a})}else!i&&!l&&x.reset({isEnabled:!0,issueType:T.Recommendation,messageTemplate:"",fixDescription:""})},[i,d]),E.useEffect(()=>{var s;if(l&&!d&&n){let a={};try{a=n.defaultConfiguration?JSON.parse(n.defaultConfiguration):{}}catch{a={}}(s=n.parameters)==null||s.forEach(r=>{r.type==="array"&&a[r.name||""]===void 0&&(a[r.name||""]=r.defaultValue||[])}),x.reset({isEnabled:!0,issueType:T.Recommendation,messageTemplate:n.defaultMessageTemplate||"",fixDescription:n.defaultFixDescription||"",...a})}},[l,d,n]);const $=s=>{var b;if(!d&&!l)return;const a=d?i==null?void 0:i.ruleType:l||void 0;if(!a)return;const r=P(S,n==null?void 0:n.resourceType)?n==null?void 0:n.resourceType:i==null?void 0:i.resourceType;if(!r)return;const m={};(b=n==null?void 0:n.parameters)==null||b.forEach(G=>{const A=G.name||"";s[A]!==void 0&&(m[A]=s[A])});const u=i?new W(i):new W;u.id=(i==null?void 0:i.id)??0,u.createdAt=(i==null?void 0:i.createdAt)??new Date,u.updatedAt=i==null?void 0:i.updatedAt,u.ruleType=a,u.resourceType=r,u.isEnabled=s.isEnabled,u.issueType=s.issueType,u.messageTemplate=s.messageTemplate,u.fixDescription=s.fixDescription||void 0,u.configuration=Object.keys(m).length>0?JSON.stringify(m):void 0,c(u)};return e.jsx(pe,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit($),className:"space-y-4",children:[n&&e.jsx(I,{children:e.jsx(k,{children:n.description})}),!d&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(fe,{children:[o("ConfigurationRules.RuleType")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs(te,{value:l||void 0,onValueChange:s=>{P(Y,s)?f(s):f("")},children:[e.jsx(ae,{children:e.jsx(oe,{placeholder:o("ConfigurationRules.SelectRuleType")})}),e.jsx(re,{children:g==null?void 0:g.map(s=>{const a=String(s.ruleType);return e.jsxs(le,{value:a,children:[s.displayName," (",s.resourceType,")"]},a)})})]}),t&&e.jsx(I,{variant:"destructive",children:e.jsx(k,{children:o("ConfigurationRules.DuplicateRuleError")})})]}),(d||l)&&e.jsxs(e.Fragment,{children:[e.jsx(R,{name:"isEnabled",label:o("ConfigurationRules.Enabled"),type:"switch"}),e.jsx(R,{name:"issueType",label:o("ConfigurationRules.IssueType"),required:!0,type:"select",selectSettings:{options:[{value:"Warning",label:o("ConfigurationRules.Warning")},{value:"Recommendation",label:o("ConfigurationRules.Recommendation")},{value:"Error",label:o("ConfigurationRules.Error")}]}}),e.jsx(R,{name:"messageTemplate",label:o("ConfigurationRules.MessageTemplate"),description:o("ConfigurationRules.MessageTemplateDescription"),required:!0,type:"input",maxLength:500}),e.jsx(R,{name:"fixDescription",label:o("ConfigurationRules.FixDescription"),description:o("ConfigurationRules.FixDescriptionDescription"),type:"textarea",maxLength:1e3})]}),(n==null?void 0:n.parameters)&&n.parameters.length>0&&e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsx("h3",{className:"font-semibold",children:o("ConfigurationRules.ConfigurationParameters")}),n.parameters.map(s=>{var r,m;const a=s.name||"";switch(s.type){case"string":return e.jsx(R,{name:a,label:s.displayName||a,description:s.description,required:s.required,type:"input",placeholder:(r=s.defaultValue)==null?void 0:r.toString()},a);case"number":return e.jsx(R,{name:a,label:s.displayName||a,description:`${s.description||""} ${s.minValue!==void 0&&s.maxValue!==void 0?`(${s.minValue} - ${s.maxValue})`:""}`,required:s.required,type:"number",placeholder:(m=s.defaultValue)==null?void 0:m.toString(),numberSettings:{showFormattedTime:!1}},a);case"boolean":return e.jsx(R,{name:a,label:s.displayName||a,description:s.description,type:"switch"},a);case"array":return e.jsx(R,{name:a,label:s.displayName||a,description:s.description,required:s.required,type:"inputWithTable"},a);default:return null}})]}),e.jsx("div",{className:"flex justify-end gap-2 pt-4",children:e.jsx(N,{type:"submit",disabled:t||!d&&!l,children:o("Actions.Save")})})]})})},Fe=({rule:i,existingRules:p,isOpen:g,onClose:c,onSuccess:d})=>{const{t:o}=D(),l=!!i,f=Z(),{data:h,isLoading:C}=z(["configurationRulesMetadata"],De,{enabled:g}),n=L(async y=>{l&&i?await Se(i.id,y):await ve(y)},{onSuccess:()=>{f.invalidateQueries([q.configurationIssues]),f.invalidateQueries([q.configurationIssuesSummary]),d()},onError:()=>{V({variant:"destructive",title:o("ConfigurationRules.SaveFailed"),description:o("ConfigurationRules.GenericError")})}}),t=y=>{n.mutate(y)};return e.jsx(_,{open:g,onOpenChange:c,children:e.jsxs(ee,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ie,{children:e.jsx(se,{children:o(l?"ConfigurationRules.EditRule":"ConfigurationRules.AddNewRule")})}),C?e.jsx(Q,{}):h&&e.jsx(Ae,{rule:i,existingRules:p,metadata:h,onSubmit:t,isEditMode:l})]})})},_e=()=>{var n;const{isOpen:i,closeModal:p,openModal:g}=ue(),{t:c}=D(),[d,o]=E.useState(null),l=z([q.configurationRules],()=>je(),{keepPreviousData:!0}),f=()=>{o(null),g()},h=t=>{o(t),g()},C=e.jsx("div",{className:"flex flex-col space-y-3 md:flex-row md:items-center md:space-x-3 md:space-y-0",children:e.jsxs(N,{onClick:f,children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),c("ConfigurationRules.AddNewRule")]})});return e.jsx(ce,{title:c("ConfigurationRules.PageTitle"),icon:ne,accentKind:"management",topSection:C,children:l.isLoading?e.jsx(Q,{fullscreen:!0}):l.data?e.jsxs(e.Fragment,{children:[e.jsx(we,{data:l.data,onEdit:h,onRefresh:l.refetch}),e.jsx(Fe,{rule:d,existingRules:((n=l.data)==null?void 0:n.rules)||[],isOpen:i,onClose:p,onSuccess:()=>{p(),l.refetch()}})]}):null})};export{_e as default};
